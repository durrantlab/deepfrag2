Bootstrap: docker
From: nvidia/cuda:11.1-cudnn8-runtime-ubuntu20.04
Stage: spython-base

%files
requirements.txt /tmp/requirements.txt
%post
# The first Cuda version to recognise the RTX3090 was 11.1. numba does not
# support cuda 11.2 or higher. https://github.com/numba/numba/issues/6607 So you
# must get thisworking in 11.1. Only option.

# FROM nvidia/cuda:11.3.0-cudnn8-runtime-ubuntu20.04
# FROM nvidia/cuda:10.9.0-cudnn8-runtime-ubuntu20.04
# FROM nvidia/cuda:11.1.1-cudnn8-runtime-ubuntu20.04
# FROM nvidia/cuda:10.1-cudnn8-runtime-ubuntu18.04
# FROM nvidia/cuda:10.2-cudnn8-runtime-ubuntu18.04

apt update && apt install -y wget unzip curl bzip2 git gcc
rm -f /miniconda
curl -LO https://repo.anaconda.com/miniconda/Miniconda3-py38_4.10.3-Linux-x86_64.sh
bash Miniconda3-py38_4.10.3-Linux-x86_64.sh -p /miniconda -b
rm Miniconda3-py38_4.10.3-Linux-x86_64.sh
PATH=/miniconda/bin:${PATH}
conda update -y conda

conda install -y pip
python3 -m pip install --upgrade pip

apt-get update && \
apt-get -y install sudo
apt-get -y install vim
apt-get -y install g++

python --version

conda install -y cudatoolkit


cd /tmp/; /miniconda/bin/python3 -m pip install -r requirements.txt -f https://download.pytorch.org/whl/cu111/torch_stable.html
# RUN cd /tmp/; /miniconda/bin/python3 -m pip install -r requirements.txt -f https://download.pytorch.org/whl/cu113/torch_stable.html
# RUN cd /tmp/; /miniconda/bin/python3 -m pip install -r requirements.txt -f https://download.pytorch.org/whl/cu101/torch_stable.html
# RUN cd /tmp/; /miniconda/bin/python3 -m pip install -r requirements.txt -f https://download.pytorch.org/whl/cu102/torch_stable.html
# RUN cd /tmp/; /miniconda/bin/python3 -m pip install -r requirements.txt -f https://download.pytorch.org/whl/nightly/cu101/torch_nightly.html

# RUN cd /tmp/; 

conda install -y -c conda-forge rdkit

# Need to install prody from git, not conda (out of date).
cd /tmp/; wget https://github.com/prody/ProDy/archive/refs/heads/master.zip; unzip master.zip; cd ProDy-master; pip install .

apt install -y lsof

cd /mnt
%environment
export PATH=/miniconda/bin:${PATH}
%runscript
cd /mnt
exec /bin/bash "$@"
%startscript
cd /mnt
exec /bin/bash "$@"
